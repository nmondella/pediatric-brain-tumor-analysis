---
title: "Analisi Completa del Dataset di Tumori Cerebrali Pediatrici"
subtitle: "Data Cleaning e Data Exploration con Analisi Statistica"
author: "Nicholas Mondella 859673"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: true
    toc_depth: 4
    number_sections: true
    fig_caption: true
    latex_engine: xelatex
    keep_tex: false
    fig_width: 10
    fig_height: 6
header-includes:
  - \usepackage{float}
  - \floatplacement{figure}{H}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{graphicx}
  - \usepackage{geometry}
  - \geometry{left=2cm,right=2cm,top=2.5cm,bottom=2.5cm}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhf{}
  - \rhead{\thepage}
  - \lhead{Analisi Tumori Cerebrali Pediatrici}
fontsize: 11pt
linestretch: 1.2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.pos = "H",
  fig.align = "center",
  fig.width = 10,
  fig.height = 6,
  out.width = "100%"
)

options(scipen = 999, digits = 4)
```

\newpage

# Introduzione e Obiettivi dello Studio

## Contesto Clinico

Questo studio presenta un'analisi approfondita di un dataset clinico contenente informazioni su **174 pazienti pediatrici** affetti da tumori cerebrali. I tumori cerebrali rappresentano la seconda forma più comune di neoplasia in età pediatrica e costituiscono la principale causa di morte per cancro nei bambini.

## Obiettivi Primari

1. **Data Cleaning**: Identificare e correggere problematiche nella qualità dei dati
2. **Data Exploration**: Analizzare le caratteristiche demografiche e cliniche dei pazienti
3. **Analisi Statistica**: Identificare relazioni significative tra variabili (p < 0.005)
4. **Insights Clinici**: Fornire evidenze per supportare decisioni cliniche

## Metodologia Statistica

L'analisi adotta una **soglia di significatività rigorosa (p < 0.005)** per minimizzare il rischio di falsi positivi, seguendo le raccomandazioni più recenti per la ricerca biomedica.

\newpage

# Descrizione del Dataset e delle Variabili

## Caratteristiche Generali del Dataset

Il dataset comprende **34 variabili** che descrivono diversi aspetti del percorso clinico dei pazienti, dalla presentazione iniziale agli outcome di sopravvivenza.

```{r load_libraries, echo=FALSE}
suppressPackageStartupMessages({
  library(readxl)
  library(dplyr)
  library(ggplot2)
  library(stats)
  library(utils)
  if(require("corrplot", quietly = TRUE)) library(corrplot)
  if(require("tidyr", quietly = TRUE)) library(tidyr)
})

theme_set(theme_minimal() + 
          theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
                plot.subtitle = element_text(hjust = 0.5, size = 12),
                axis.title = element_text(size = 11),
                axis.text = element_text(size = 9),
                legend.text = element_text(size = 9)))
```

```{r load_data, echo=FALSE}
data_path <- "../data/data.xlsx"
raw_data <- read_excel(data_path)
```

## Classificazione delle Variabili Cliniche

Le variabili del dataset possono essere classificate in diverse categorie cliniche:

### Variabili Demografiche
- **Pat. No.**: Identificativo univoco del paziente
- **Sex**: Sesso del paziente (1 = Maschio, 2 = Femmina)
- **Age**: Anno di nascita del paziente

### Variabili di Presentazione Clinica
- **Duration of symptoms before diagnosis**: Durata dei sintomi prima della diagnosi (giorni)
- **Increased ICP**: Presenza di ipertensione intracranica (1 = Sì, 2 = No)
- **Epileptic seizures**: Presenza di crisi epilettiche (1 = Sì, 2 = No)
- **Neurological deficit**: Presenza di deficit neurologici (1 = Sì, 2 = No)
- **Hormonal abnormalities**: Presenza di alterazioni ormonali (1 = Sì, 2 = No)

### Variabili Anatomopatologiche
- **Embryonal tumors**: Tumori embrionali (1 = Sì, 2 = No)
- **HGG**: Gliomi di alto grado (1 = Sì, 2 = No)
- **LGG**: Gliomi di basso grado (1 = Sì, 2 = No)
- **Craniopharyngeoma**: Craniofaringioma (1 = Sì, 2 = No)
- **GCT / NGCT**: Tumori a cellule germinali (1 = Sì, 2 = No)
- **Ependymoma**: Ependimoma (1 = Sì, 2 = No)

### Variabili di Trattamento
- **Operation type**: Tipo di intervento chirurgico
- **Radiotherapy**: Radioterapia (1 = Sì, 2 = No)
- **Neoadjuvant HT**: Chemioterapia neoadiuvante (1 = Sì, 2 = No)
- **Concomitant HT**: Chemioterapia concomitante (1 = Sì, 2 = No)
- **Adjuvant HT**: Chemioterapia adiuvante (1 = Sì, 2 = No)

### Variabili di Outcome
- **OS**: Overall Survival (sopravvivenza globale in mesi)
- **Status OS**: Stato di sopravvivenza (1 = Deceduto, 2 = Vivo)

\newpage

# Analisi della Qualità dei Dati

## Valutazione Complessiva dei Valori Mancanti

Prima di procedere con qualsiasi analisi statistica, è fondamentale valutare la **completezza del dataset** e identificare i pattern dei valori mancanti.

```{r missing_analysis_intro}
missing_summary <- data.frame(
  Variabile = names(raw_data),
  Valori_Mancanti = sapply(raw_data, function(x) sum(is.na(x))),
  Percentuale = round(sapply(raw_data, function(x) sum(is.na(x)) / length(x) * 100), 2),
  stringsAsFactors = FALSE
)
missing_summary <- missing_summary[order(missing_summary$Percentuale, decreasing = TRUE), ]

knitr::kable(missing_summary[missing_summary$Valori_Mancanti > 0, ], 
             caption = "Variabili con Valori Mancanti nel Dataset",
             booktabs = TRUE, row.names = FALSE)
```

### Interpretazione dei Valori Mancanti

I valori mancanti nel contesto clinico possono avere diversi significati:

1. **Missing Completely at Random (MCAR)**: Dati persi casualmente
2. **Missing at Random (MAR)**: Dati mancanti dipendenti da altre variabili osservate
3. **Missing Not at Random (MNAR)**: Dati mancanti correlati al valore stesso

## Visualizzazione Pattern dei Valori Mancanti

```{r missing_visualization}
missing_counts <- sapply(raw_data, function(x) sum(is.na(x)))
vars_with_missing <- missing_counts[missing_counts > 0]

if(length(vars_with_missing) > 0) {
  par(mar = c(12, 4, 4, 2))
  barplot(vars_with_missing, 
          main = "Distribuzione dei Valori Mancanti per Variabile",
          ylab = "Numero di Valori Mancanti",
          las = 2, col = "lightcoral",
          cex.names = 0.8)
  par(mar = c(5, 4, 4, 2))
}
```

### Spiegazione dei Valori Mancanti Clinicamente Rilevanti

- **CSF cytology finding**: Mancante quando l'esame del liquor non è stato eseguito
- **CSI dose/Boost dose**: Mancante quando non è stata somministrata radioterapia
- **Operation type**: Mancante quando non è stato eseguito intervento chirurgico

\newpage

# Data Cleaning: Strategia di Trattamento

## Strategia Clinicamente Informata

La strategia di cleaning deve rispettare il **significato clinico** dei valori mancanti:

```{r data_cleaning_strategy}
cleaned_data <- raw_data

cat("=== STRATEGIA DI TRATTAMENTO VALORI MANCANTI ===\n")
cat("Totale pazienti nel dataset:", nrow(cleaned_data), "\n\n")

for(col in names(cleaned_data)) {
  missing_pct <- sum(is.na(cleaned_data[[col]])) / nrow(cleaned_data) * 100
  
  if(missing_pct > 50) {
    cat("[RIMOZIONE]", col, ":", round(missing_pct, 1), "% mancanti\n")
  } else if(missing_pct > 20) {
    cat("[IMPUTAZIONE AVANZATA]", col, ":", round(missing_pct, 1), "% mancanti\n")
  } else if(missing_pct > 5) {
    cat("[IMPUTAZIONE SEMPLICE]", col, ":", round(missing_pct, 1), "% mancanti\n")
  } else if(missing_pct > 0) {
    cat("[GESTIONE SPECIFICA]", col, ":", round(missing_pct, 1), "% mancanti\n")
  }
}
```

## Applicazione delle Strategie di Cleaning

### Rimozione Variabili con Eccessivi Valori Mancanti

```{r remove_high_missing}
high_missing_vars <- missing_summary$Variabile[missing_summary$Percentuale > 50]
if(length(high_missing_vars) > 0) {
  cleaned_data <- cleaned_data[, !names(cleaned_data) %in% high_missing_vars]
  cat("Variabili rimosse:", paste(high_missing_vars, collapse = ", "), "\n")
} else {
  cat("Nessuna variabile rimossa per eccesso di valori mancanti\n")
}
```

### Imputazione per Variabili Numeriche

```{r impute_numeric}
numeric_vars_clean <- cleaned_data[sapply(cleaned_data, is.numeric)]
if(ncol(numeric_vars_clean) > 0) {
  for(col in names(numeric_vars_clean)) {
    if(sum(is.na(cleaned_data[[col]])) > 0) {
      median_val <- median(cleaned_data[[col]], na.rm = TRUE)
      n_imputed <- sum(is.na(cleaned_data[[col]]))
      cleaned_data[[col]][is.na(cleaned_data[[col]])] <- median_val
      cat("[OK] Imputata mediana per", col, ":", median_val, "(", n_imputed, "valori)\n")
    }
  }
}
```

### Gestione Outliers con Approccio Clinico

```{r outlier_treatment_clinical}
numeric_vars_final <- cleaned_data[sapply(cleaned_data, is.numeric)]

if(ncol(numeric_vars_final) > 0) {
  outliers_treated <- cleaned_data
  
  for(col in names(numeric_vars_final)) {
    p5 <- quantile(cleaned_data[[col]], 0.05, na.rm = TRUE)
    p95 <- quantile(cleaned_data[[col]], 0.95, na.rm = TRUE)
    
    outliers_before <- sum(cleaned_data[[col]] < p5 | cleaned_data[[col]] > p95, na.rm = TRUE)
    
    outliers_treated[[col]] <- pmax(pmin(cleaned_data[[col]], p95), p5)
    
    if(outliers_before > 0) {
      cat("[OUTLIERS] Outliers trattati per", col, ":", outliers_before, "valori\n")
    }
  }
  
  cleaned_data <- outliers_treated
}

cat("[DATASET FINALE]", nrow(cleaned_data), "pazienti x", ncol(cleaned_data), "variabili\n")
```

\newpage

# Analisi Esplorativa: Caratteristiche Demografiche

## Distribuzione per Sesso

L'analisi della distribuzione per sesso è fondamentale per comprendere se esistono **bias di selezione** o **differenze epidemiologiche** nella popolazione studiata.

```{r sex_distribution}
sex_table <- table(cleaned_data$Sex, useNA = "ifany")
sex_prop <- prop.table(sex_table) * 100

sex_labels <- c("Maschi", "Femmina")
names(sex_table) <- sex_labels
names(sex_prop) <- sex_labels

knitr::kable(data.frame(
  Sesso = names(sex_table),
  Frequenza = as.numeric(sex_table),
  Percentuale = round(as.numeric(sex_prop), 1)
), caption = "Distribuzione per Sesso dei Pazienti", booktabs = TRUE, row.names = FALSE)
```

```{r sex_plot}
par(mfrow = c(1, 2))

pie(sex_table, 
    main = "Distribuzione per Sesso",
    col = c("lightblue", "lightpink"),
    labels = paste(names(sex_table), "\n", round(sex_prop, 1), "%"))

barplot(sex_table,
        main = "Frequenza per Sesso",
        ylab = "Numero di Pazienti",
        col = c("lightblue", "lightpink"),
        las = 1)

par(mfrow = c(1, 1))
```

### Interpretazione Clinica della Distribuzione per Sesso

La distribuzione per sesso mostra se esiste una **predominanza di genere** nei tumori cerebrali pediatrici di questo campione, informazione cruciale per:
- Identificare possibili fattori di rischio legati al sesso
- Confrontare con la letteratura epidemiologica esistente
- Pianificare studi di follow-up stratificati per genere

## Analisi dell'Età dei Pazienti

```{r age_analysis}
age_stats <- data.frame(
  Statistica = c("N. Pazienti", "Media", "Mediana", "Dev. Standard", "Minimo", "Massimo", "Range"),
  Valore = c(
    sum(!is.na(cleaned_data$Age)),
    round(mean(cleaned_data$Age, na.rm = TRUE), 1),
    round(median(cleaned_data$Age, na.rm = TRUE), 1),
    round(sd(cleaned_data$Age, na.rm = TRUE), 1),
    min(cleaned_data$Age, na.rm = TRUE),
    max(cleaned_data$Age, na.rm = TRUE),
    max(cleaned_data$Age, na.rm = TRUE) - min(cleaned_data$Age, na.rm = TRUE)
  )
)

knitr::kable(age_stats, 
             caption = "Statistiche Descrittive dell'Età (Anno di Nascita)",
             booktabs = TRUE, row.names = FALSE)
```

```{r age_distribution_plot}
hist(cleaned_data$Age, 
     breaks = 20,
     main = "Distribuzione dell'Anno di Nascita dei Pazienti",
     xlab = "Anno di Nascita",
     ylab = "Frequenza",
     col = "lightsteelblue",
     border = "black")

abline(v = mean(cleaned_data$Age, na.rm = TRUE), col = "red", lwd = 2, lty = 2)
abline(v = median(cleaned_data$Age, na.rm = TRUE), col = "blue", lwd = 2, lty = 2)

legend("topright", 
       legend = c("Media", "Mediana"),
       col = c("red", "blue"),
       lty = 2, lwd = 2)
```

### Significato Clinico dell'Analisi dell'Età

L'analisi dell'età è cruciale perché:
- I **tumori cerebrali pediatrici** hanno picchi di incidenza specifici per età
- L'**età alla diagnosi** influenza la prognosi e le opzioni terapeutiche
- Diversi **istotipi tumorali** hanno predilezioni per fasce d'età specifiche

\newpage

# Analisi della Presentazione Clinica

## Durata dei Sintomi Prima della Diagnosi

La durata dei sintomi prima della diagnosi è un **indicatore prognostico importante** che riflette l'aggressività del tumore e l'efficacia del sistema sanitario.

```{r symptom_duration_analysis}
duration_stats <- data.frame(
  Statistica = c("N. Pazienti", "Media (giorni)", "Mediana (giorni)", "Dev. Standard", 
                 "Minimo", "Massimo", "Q1", "Q3"),
  Valore = c(
    sum(!is.na(cleaned_data$`Duration of sympthoms before diagnosis (days)`)),
    round(mean(cleaned_data$`Duration of sympthoms before diagnosis (days)`, na.rm = TRUE), 1),
    round(median(cleaned_data$`Duration of sympthoms before diagnosis (days)`, na.rm = TRUE), 1),
    round(sd(cleaned_data$`Duration of sympthoms before diagnosis (days)`, na.rm = TRUE), 1),
    min(cleaned_data$`Duration of sympthoms before diagnosis (days)`, na.rm = TRUE),
    max(cleaned_data$`Duration of sympthoms before diagnosis (days)`, na.rm = TRUE),
    round(quantile(cleaned_data$`Duration of sympthoms before diagnosis (days)`, 0.25, na.rm = TRUE), 1),
    round(quantile(cleaned_data$`Duration of sympthoms before diagnosis (days)`, 0.75, na.rm = TRUE), 1)
  )
)

knitr::kable(duration_stats,
             caption = "Statistiche della Durata dei Sintomi Prima della Diagnosi",
             booktabs = TRUE, row.names = FALSE)
```

```{r symptom_duration_plots}
par(mfrow = c(1, 2))

hist(cleaned_data$`Duration of sympthoms before diagnosis (days)`,
     breaks = 30,
     main = "Distribuzione Durata Sintomi",
     xlab = "Giorni",
     ylab = "Frequenza",
     col = "lightgreen",
     border = "black")

boxplot(cleaned_data$`Duration of sympthoms before diagnosis (days)`,
        main = "Box Plot Durata Sintomi",
        ylab = "Giorni",
        col = "lightgreen",
        outline = TRUE)

par(mfrow = c(1, 1))
```

### Interpretazione Clinica della Durata dei Sintomi

- **Mediana bassa**: Suggerisce tumori ad crescita rapida o sistema sanitario efficiente
- **Outliers elevati**: Possibili tumori a crescita lenta o ritardi diagnostici
- **Distribuzione**: Fornisce insights sull'eterogeneità biologica dei tumori

## Analisi dei Sintomi Neurologici

```{r neurological_symptoms}
symptoms <- c("Increased ICP", "Epileptic seizures", "Neurological deficit", "Hormonal abnormalities")
symptom_analysis <- data.frame(
  Sintomo = c("Ipertensione Intracranica", "Crisi Epilettiche", "Deficit Neurologici", "Alterazioni Ormonali"),
  Presenti = sapply(symptoms, function(x) sum(cleaned_data[[x]] == 1, na.rm = TRUE)),
  Assenti = sapply(symptoms, function(x) sum(cleaned_data[[x]] == 2, na.rm = TRUE)),
  Prevalenza_Perc = round(sapply(symptoms, function(x) 
    sum(cleaned_data[[x]] == 1, na.rm = TRUE) / sum(!is.na(cleaned_data[[x]])) * 100), 1)
)

knitr::kable(symptom_analysis,
             caption = "Prevalenza dei Sintomi Neurologici alla Presentazione",
             booktabs = TRUE, row.names = FALSE)
```

```{r symptoms_visualization}
barplot(symptom_analysis$Prevalenza_Perc,
        names.arg = c("ICP↑", "Epilessia", "Deficit\nNeurol.", "Altera.\nOrmonali"),
        main = "Prevalenza dei Sintomi Neurologici",
        ylab = "Prevalenza (%)",
        col = c("red", "orange", "yellow", "lightgreen"),
        las = 1,
        cex.names = 0.9)

abline(h = 50, col = "blue", lty = 2)
text(2.5, 55, "50%", col = "blue", cex = 0.8)
```

### Significato Clinico dei Sintomi Neurologici

1. **Ipertensione Intracranica**: Indica effetto massa o ostruzione del flusso liquorale
2. **Crisi Epilettiche**: Comune nei tumori corticali o subcorticali
3. **Deficit Neurologici**: Riflettono localizzazione e invasività del tumore
4. **Alterazioni Ormonali**: Tipiche dei tumori della regione sellare/ipotalamica

\newpage

# Analisi degli Istotipi Tumorali

## Distribuzione degli Istotipi

La classificazione istopatologica è **fondamentale** per la stratificazione prognostica e la pianificazione terapeutica.

```{r histotype_analysis}
histotypes <- c("Embryonal tumors", "HGG", "LGG", "Craniopharyngeoma", 
                "GCT / NGCT", "Ependymoma", "Glioneural Tu", "Pineal Tu", 
                "Choroid plexus Tu", "Other", "Unknown")

histotype_names <- c("Tumori Embrionali", "Gliomi Alto Grado", "Gliomi Basso Grado",
                     "Craniofaringioma", "Tumori Cellule Germinali", "Ependimoma",
                     "Tumori Glioneurali", "Tumori Pineali", "Tumori Plesso Coroideo",
                     "Altri", "Sconosciuti")

histotype_data <- data.frame(
  Istotipo = histotype_names,
  Casi = sapply(histotypes, function(x) sum(cleaned_data[[x]] == 1, na.rm = TRUE)),
  Percentuale = round(sapply(histotypes, function(x) 
    sum(cleaned_data[[x]] == 1, na.rm = TRUE) / nrow(cleaned_data) * 100), 1)
)

histotype_data <- histotype_data[histotype_data$Casi > 0, ]
histotype_data <- histotype_data[order(histotype_data$Casi, decreasing = TRUE), ]

knitr::kable(histotype_data,
             caption = "Distribuzione degli Istotipi Tumorali",
             booktabs = TRUE, row.names = FALSE)
```

```{r histotype_visualization}
par(mar = c(8, 4, 4, 2))
barplot(histotype_data$Casi,
        names.arg = histotype_data$Istotipo,
        main = "Distribuzione degli Istotipi Tumorali",
        ylab = "Numero di Casi",
        col = rainbow(nrow(histotype_data)),
        las = 2,
        cex.names = 0.7)
par(mar = c(5, 4, 4, 2))
```

### Significato Clinico degli Istotipi

1. **Gliomi di Basso Grado (LGG)**: Prognosi generalmente favorevole, crescita lenta
2. **Gliomi di Alto Grado (HGG)**: Prognosi infausta, crescita rapida, alta invasività
3. **Tumori Embrionali**: Altamente maligni, richiedono protocolli intensivi
4. **Craniofaringioma**: Benign ma localizzazione critica, alte sequele
5. **Ependimoma**: Prognosi dipendente da grado e localizzazione

## Correlazione tra Istotipo e Localizzazione

```{r histotype_location}
location_table <- table(cleaned_data$Localisation, useNA = "ifany")
location_labels <- c("Sopratentoriale", "Sottotentoriale")

cat("Distribuzione per Localizzazione:\n")
cat("Sopratentoriale:", sum(cleaned_data$Localisation == 1, na.rm = TRUE), "casi\n")
cat("Sottotentoriale:", sum(cleaned_data$Localisation == 2, na.rm = TRUE), "casi\n")
```

### Implicazioni Cliniche della Localizzazione

- **Tumori Sopratentoriali**: Spesso associati a crisi epilettiche e deficit focali
- **Tumori Sottotentoriali**: Frequentemente causano ipertensione intracranica e atassia

\newpage

# Analisi delle Strategie Terapeutiche

## Approcci Chirurgici

La chirurgia rappresenta il **gold standard** per la diagnosi e spesso il primo step terapeutico nei tumori cerebrali pediatrici.

```{r surgery_analysis}
surgery_data <- table(cleaned_data$`Operation type`, useNA = "ifany")
surgery_total <- sum(!is.na(cleaned_data$`Operation type`))

cat("Analisi degli Interventi Chirurgici:\n")
cat("Pazienti operati:", surgery_total, "su", nrow(cleaned_data), 
    "(", round(surgery_total/nrow(cleaned_data)*100, 1), "%)\n")
cat("Pazienti non operati:", sum(is.na(cleaned_data$`Operation type`)), "\n\n")

if(surgery_total > 0) {
  cat("Distribuzione dei tipi di intervento:\n")
  for(i in 1:length(surgery_data)) {
    if(!is.na(names(surgery_data)[i])) {
      perc <- round(surgery_data[i] / surgery_total * 100, 1)
      cat("Tipo", names(surgery_data)[i], ":", surgery_data[i], "casi (", perc, "%)\n")
    }
  }
}
```

## Radioterapia

```{r radiotherapy_analysis}
rt_table <- table(cleaned_data$Radiotherapy, useNA = "ifany")
rt_yes <- sum(cleaned_data$Radiotherapy == 1, na.rm = TRUE)
rt_no <- sum(cleaned_data$Radiotherapy == 2, na.rm = TRUE)

rt_data <- data.frame(
  Trattamento = c("Radioterapia Sì", "Radioterapia No"),
  Pazienti = c(rt_yes, rt_no),
  Percentuale = round(c(rt_yes, rt_no) / (rt_yes + rt_no) * 100, 1)
)

knitr::kable(rt_data,
             caption = "Utilizzo della Radioterapia",
             booktabs = TRUE, row.names = FALSE)
```

```{r rt_dosage_analysis}
total_dose_stats <- data.frame(
  Statistica = c("N. Pazienti con Dose", "Dose Media (Gy)", "Dose Mediana (Gy)", 
                 "Dev. Standard", "Dose Minima (Gy)", "Dose Massima (Gy)"),
  Valore = c(
    sum(!is.na(cleaned_data$`Total dose`)),
    round(mean(cleaned_data$`Total dose`, na.rm = TRUE), 1),
    round(median(cleaned_data$`Total dose`, na.rm = TRUE), 1),
    round(sd(cleaned_data$`Total dose`, na.rm = TRUE), 1),
    round(min(cleaned_data$`Total dose`, na.rm = TRUE), 1),
    round(max(cleaned_data$`Total dose`, na.rm = TRUE), 1)
  )
)

knitr::kable(total_dose_stats,
             caption = "Statistiche della Dose Totale di Radioterapia",
             booktabs = TRUE, row.names = FALSE)
```

### Significato Clinico delle Dosi di Radioterapia

- **Dose < 30 Gy**: Tipica per tumori radiosensibili o pazienti molto giovani
- **Dose 50-60 Gy**: Standard per la maggior parte dei tumori cerebrali
- **Dose > 60 Gy**: Riservata a tumori radioresistenti con controllo locale critico

## Chemioterapia

```{r chemotherapy_analysis}
chemo_vars <- c("Neoadjuvant HT", "Concomitant HT", "Adjuvant HT")
chemo_names <- c("Neoadiuvante", "Concomitante", "Adiuvante")

chemo_data <- data.frame(
  Tipo_Chemioterapia = chemo_names,
  Pazienti_Trattati = sapply(chemo_vars, function(x) sum(cleaned_data[[x]] == 1, na.rm = TRUE)),
  Percentuale = round(sapply(chemo_vars, function(x) 
    sum(cleaned_data[[x]] == 1, na.rm = TRUE) / sum(!is.na(cleaned_data[[x]])) * 100), 1)
)

knitr::kable(chemo_data,
             caption = "Utilizzo della Chemioterapia per Tipo",
             booktabs = TRUE, row.names = FALSE)
```

### Razionale Clinico dei Diversi Timing di Chemioterapia

1. **Neoadiuvante**: Riduzione dimensioni tumore pre-chirurgia
2. **Concomitante**: Radiosensibilizzazione durante radioterapia  
3. **Adiuvante**: Prevenzione recidive post-trattamento locale

\newpage

# Analisi di Sopravvivenza

## Overall Survival (OS)

L'analisi della sopravvivenza globale rappresenta l'**endpoint primario** più importante negli studi oncologici pediatrici.

```{r survival_analysis}
os_stats <- data.frame(
  Statistica = c("N. Pazienti", "OS Media (mesi)", "OS Mediana (mesi)", 
                 "Dev. Standard", "OS Minima (mesi)", "OS Massima (mesi)",
                 "Pazienti Vivi", "Pazienti Deceduti"),
  Valore = c(
    sum(!is.na(cleaned_data$OS)),
    round(mean(cleaned_data$OS, na.rm = TRUE), 1),
    round(median(cleaned_data$OS, na.rm = TRUE), 1),
    round(sd(cleaned_data$OS, na.rm = TRUE), 1),
    min(cleaned_data$OS, na.rm = TRUE),
    max(cleaned_data$OS, na.rm = TRUE),
    sum(cleaned_data$`Status OS` == 2, na.rm = TRUE),
    sum(cleaned_data$`Status OS` == 1, na.rm = TRUE)
  )
)

knitr::kable(os_stats,
             caption = "Statistiche di Sopravvivenza Globale",
             booktabs = TRUE, row.names = FALSE)
```

```{r survival_plots}
par(mfrow = c(1, 2))

hist(cleaned_data$OS,
     breaks = 20,
     main = "Distribuzione Overall Survival",
     xlab = "Mesi di Sopravvivenza",
     ylab = "Frequenza",
     col = "lightcyan",
     border = "black")

status_table <- table(cleaned_data$`Status OS`)
status_labels <- c("Deceduto", "Vivo")
pie(status_table,
    labels = paste(status_labels, "\n", status_table, " pazienti"),
    main = "Status di Sopravvivenza",
    col = c("red", "green"))

par(mfrow = c(1, 1))
```

### Interpretazione Clinica dei Dati di Sopravvivenza

- **Mediana di sopravvivenza**: Indica il tempo entro cui il 50% dei pazienti è ancora vivo
- **Distribuzione bimodale**: Potrebbe suggerire sottogruppi prognostici distinti
- **Outliers di lunga sopravvivenza**: Identificano pazienti con caratteristiche prognostiche favorevoli

\newpage

# Analisi delle Correlazioni Statisticamente Significative

## Matrice di Correlazione delle Variabili Numeriche

L'analisi delle correlazioni permette di identificare **associazioni lineari** tra variabili cliniche, fondamentali per comprendere le interrelazioni prognostiche.

```{r correlation_matrix}
numeric_vars_final <- cleaned_data[sapply(cleaned_data, is.numeric)]
numeric_vars_final <- numeric_vars_final[, !names(numeric_vars_final) %in% c("Pat. No.")]

cor_matrix <- cor(numeric_vars_final, use = "complete.obs")

cat("Variabili incluse nell'analisi di correlazione:\n")
for(i in 1:ncol(numeric_vars_final)) {
  cat(i, ".", names(numeric_vars_final)[i], "\n")
}
```

```{r correlation_visualization}
if(require("corrplot", quietly = TRUE) && !any(is.na(cor_matrix)) && nrow(cor_matrix) > 1) {
  corrplot(cor_matrix, 
           method = "color",
           type = "upper",
           order = "original",
           tl.cex = 0.7,
           tl.col = "black",
           tl.srt = 45,
           addCoef.col = "black",
           number.cex = 0.6,
           title = "Matrice di Correlazione delle Variabili Numeriche",
           mar = c(0,0,1,0))
} else {
  image(1:nrow(cor_matrix), 1:ncol(cor_matrix), cor_matrix,
        main = "Matrice di Correlazione",
        xlab = "", ylab = "",
        axes = FALSE,
        col = heat.colors(20))
  axis(1, at = 1:nrow(cor_matrix), labels = rownames(cor_matrix), las = 2, cex.axis = 0.7)
  axis(2, at = 1:ncol(cor_matrix), labels = colnames(cor_matrix), las = 2, cex.axis = 0.7)
}
```

## Test di Significatività delle Correlazioni (p < 0.005)

```{r correlation_significance}
significant_correlations <- data.frame()

for(i in 1:(ncol(numeric_vars_final)-1)) {
  for(j in (i+1):ncol(numeric_vars_final)) {
    var1 <- names(numeric_vars_final)[i]
    var2 <- names(numeric_vars_final)[j]
    
    tryCatch({
      test_result <- cor.test(numeric_vars_final[[i]], numeric_vars_final[[j]])
      
      if(!is.na(test_result$estimate) && !is.na(test_result$p.value)) {
        result_row <- data.frame(
          Variabile_1 = var1,
          Variabile_2 = var2,
          Correlazione = round(test_result$estimate, 4),
          p_value = format(test_result$p.value, scientific = TRUE, digits = 3),
          Significativa = ifelse(test_result$p.value < 0.005, "SI", "NO"),
          stringsAsFactors = FALSE
        )
        significant_correlations <- rbind(significant_correlations, result_row)
      }
    }, error = function(e) {})
  }
}

if(nrow(significant_correlations) > 0) {
  sig_corr_005 <- significant_correlations[significant_correlations$Significativa == "SI", ]
  
  if(nrow(sig_corr_005) > 0) {
    sig_corr_005 <- sig_corr_005[order(abs(as.numeric(sig_corr_005$Correlazione)), decreasing = TRUE), ]
    
    knitr::kable(sig_corr_005,
                 caption = "Correlazioni Statisticamente Significative (p < 0.005)",
                 booktabs = TRUE, row.names = FALSE)
  } else {
    cat("[NESSUNA CORRELAZIONE] Nessuna correlazione statisticamente significativa trovata con p < 0.005\n")
  }
} else {
  cat("[NESSUNA CORRELAZIONE] Impossibile calcolare correlazioni significative\n")
}
```

### Interpretazione Clinica delle Correlazioni Significative

Le correlazioni statisticamente significative identificate forniscono insight sui **meccanismi biologici** e **associazioni prognostiche**:

- **Correlazioni positive forti (r > 0.7)**: Suggeriscono relazioni causali dirette
- **Correlazioni negative significative**: Indicano meccanismi compensatori o competitivi
- **Correlazioni moderate (0.3 < |r| < 0.7)**: Riflettono associazioni clinicamente rilevanti

\newpage

# Test Statistici per Differenze tra Gruppi

## Confronto tra Istotipi e Outcome Clinici

### Test per Sopravvivenza tra Gliomi di Alto e Basso Grado

```{r glioma_survival_test}
lgg_patients <- cleaned_data[cleaned_data$LGG == 1, ]
hgg_patients <- cleaned_data[cleaned_data$HGG == 1, ]

if(nrow(lgg_patients) > 3 && nrow(hgg_patients) > 3) {
  
  lgg_os <- lgg_patients$OS[!is.na(lgg_patients$OS)]
  hgg_os <- hgg_patients$OS[!is.na(hgg_patients$OS)]
  
  if(length(lgg_os) > 0 && length(hgg_os) > 0) {
    t_test_result <- t.test(lgg_os, hgg_os)
    
    test_summary <- data.frame(
      Gruppo = c("Gliomi Basso Grado (LGG)", "Gliomi Alto Grado (HGG)"),
      N_Pazienti = c(length(lgg_os), length(hgg_os)),
      OS_Media = round(c(mean(lgg_os), mean(hgg_os)), 1),
      OS_Mediana = round(c(median(lgg_os), median(hgg_os)), 1),
      Dev_Standard = round(c(sd(lgg_os), sd(hgg_os)), 1)
    )
    
    knitr::kable(test_summary,
                 caption = "Confronto Sopravvivenza: Gliomi di Basso vs Alto Grado",
                 booktabs = TRUE, row.names = FALSE)
    
    cat("\n[RISULTATI DEL T-TEST]:\n")
    cat("Statistica t:", round(t_test_result$statistic, 4), "\n")
    cat("p-value:", format(t_test_result$p.value, scientific = TRUE, digits = 3), "\n")
    cat("Significativo (p < 0.005):", ifelse(t_test_result$p.value < 0.005, "SI", "NO"), "\n")
    
    if(t_test_result$p.value < 0.005) {
      cat("Intervallo di confidenza 95%:", round(t_test_result$conf.int, 2), "\n")
    }
  }
}
```

### Significato Clinico del Confronto LGG vs HGG

Questo confronto è **fondamentale** perché:
- I **gliomi di basso grado** hanno tipicamente prognosi migliore
- I **gliomi di alto grado** richiedono trattamenti più aggressivi
- La **differenza nella sopravvivenza** valida la classificazione prognostica

## Analisi della Sopravvivenza per Localizzazione

```{r location_survival_test}
supra_patients <- cleaned_data[cleaned_data$Localisation == 1, ]
infra_patients <- cleaned_data[cleaned_data$Localisation == 2, ]

if(nrow(supra_patients) > 3 && nrow(infra_patients) > 3) {
  
  supra_os <- supra_patients$OS[!is.na(supra_patients$OS)]
  infra_os <- infra_patients$OS[!is.na(infra_patients$OS)]
  
  if(length(supra_os) > 0 && length(infra_os) > 0) {
    t_test_location <- t.test(supra_os, infra_os)
    
    location_summary <- data.frame(
      Localizzazione = c("Sopratentoriale", "Sottotentoriale"),
      N_Pazienti = c(length(supra_os), length(infra_os)),
      OS_Media = round(c(mean(supra_os), mean(infra_os)), 1),
      OS_Mediana = round(c(median(supra_os), median(infra_os)), 1),
      Dev_Standard = round(c(sd(supra_os), sd(infra_os)), 1)
    )
    
    knitr::kable(location_summary,
                 caption = "Confronto Sopravvivenza per Localizzazione Tumorale",
                 booktabs = TRUE, row.names = FALSE)
    
    cat("\n[RISULTATI DEL T-TEST (LOCALIZZAZIONE)]:\n")
    cat("Statistica t:", round(t_test_location$statistic, 4), "\n")
    cat("p-value:", format(t_test_location$p.value, scientific = TRUE, digits = 3), "\n")
    cat("Significativo (p < 0.005):", ifelse(t_test_location$p.value < 0.005, "SI", "NO"), "\n")
  }
}
```

## ANOVA per Confronto Multiple di Istotipi

```{r anova_histotypes}
major_histotypes <- c("LGG", "HGG", "Embryonal tumors", "Craniopharyngeoma")
histotype_os_data <- data.frame()

for(hist in major_histotypes) {
  patients <- cleaned_data[cleaned_data[[hist]] == 1, ]
  if(nrow(patients) >= 3) {
    os_values <- patients$OS[!is.na(patients$OS)]
    if(length(os_values) > 0) {
      temp_data <- data.frame(
        OS = os_values,
        Histotype = hist
      )
      histotype_os_data <- rbind(histotype_os_data, temp_data)
    }
  }
}

if(nrow(histotype_os_data) > 0 && length(unique(histotype_os_data$Histotype)) > 2) {
  
  anova_result <- aov(OS ~ Histotype, data = histotype_os_data)
  anova_summary <- summary(anova_result)
  
  p_value_anova <- anova_summary[[1]][["Pr(>F)"]][1]
  f_statistic <- anova_summary[[1]][["F value"]][1]
  
  cat("[RISULTATI DELL'ANOVA (ISTOTIPI vs SOPRAVVIVENZA)]:\n")
  cat("F-statistic:", round(f_statistic, 4), "\n")
  cat("p-value:", format(p_value_anova, scientific = TRUE, digits = 3), "\n")
  cat("Significativo (p < 0.005):", ifelse(p_value_anova < 0.005, "SI", "NO"), "\n\n")
  
  histotype_means <- aggregate(OS ~ Histotype, data = histotype_os_data, 
                              FUN = function(x) c(Mean = mean(x), Median = median(x), N = length(x)))
  
  knitr::kable(do.call(data.frame, histotype_means),
               caption = "Sopravvivenza Media per Istotipo Tumorale",
               booktabs = TRUE)
}
```

### Interpretazione Clinica dell'ANOVA

L'ANOVA permette di **testare simultaneamente** le differenze di sopravvivenza tra più istotipi, fornendo:
- **Significatività globale**: Se esiste almeno una differenza significativa
- **Controllo errore Tipo I**: Evita test multipli non corretti
- **Base per analisi post-hoc**: Identifica quali confronti specifici esplorare

\newpage

# Modello Predittivo di Sopravvivenza

## Regressione Lineare Multipla per Predizione OS

La costruzione di un **modello predittivo** permette di quantificare l'impatto relativo dei diversi fattori prognostici sulla sopravvivenza.

```{r regression_model}
predictor_vars <- c("Age", "Duration of sympthoms before diagnosis (days)", 
                   "Increased ICP", "Epileptic seizures", "Neurological deficit",
                   "LGG", "HGG", "Radiotherapy")

regression_data <- cleaned_data[, c("OS", predictor_vars)]
regression_data <- regression_data[complete.cases(regression_data), ]

if(nrow(regression_data) >= 20) {
  
  lm_model <- lm(OS ~ ., data = regression_data)
  model_summary <- summary(lm_model)
  
  cat("[STATISTICHE DEL MODELLO DI REGRESSIONE]:\n")
  cat("R-quadrato:", round(model_summary$r.squared, 4), "\n")
  cat("R-quadrato aggiustato:", round(model_summary$adj.r.squared, 4), "\n")
  cat("N. osservazioni:", nrow(regression_data), "\n")
  
  f_statistic <- model_summary$fstatistic
  if(!is.null(f_statistic)) {
    f_p_value <- pf(f_statistic[1], f_statistic[2], f_statistic[3], lower.tail = FALSE)
    cat("F-statistic p-value:", format(f_p_value, scientific = TRUE, digits = 3), "\n")
    cat("Modello significativo (p < 0.005):", ifelse(f_p_value < 0.005, "SI", "NO"), "\n\n")
  }
  
  coeff_table <- data.frame(
    Variabile = rownames(model_summary$coefficients),
    Coefficiente = round(model_summary$coefficients[, "Estimate"], 4),
    Errore_Standard = round(model_summary$coefficients[, "Std. Error"], 4),
    t_value = round(model_summary$coefficients[, "t value"], 4),
    p_value = format(model_summary$coefficients[, "Pr(>|t|)"], scientific = TRUE, digits = 3),
    Significativo = ifelse(model_summary$coefficients[, "Pr(>|t|)"] < 0.005, "SI", "NO"),
    stringsAsFactors = FALSE
  )
  
  knitr::kable(coeff_table,
               caption = "Coefficienti del Modello di Regressione per Overall Survival",
               booktabs = TRUE, row.names = FALSE)
}
```

## Diagnostica del Modello

```{r model_diagnostics}
if(exists("lm_model")) {
  par(mfrow = c(2, 2))
  plot(lm_model, main = "Diagnostica del Modello di Regressione")
  par(mfrow = c(1, 1))
}
```

### Interpretazione dei Coefficienti del Modello

I **coefficienti significativi** del modello forniscono informazioni quantitative sull'impatto prognostico:

- **Coefficiente positivo**: Aumento della variabile associato a maggiore sopravvivenza
- **Coefficiente negativo**: Aumento della variabile associato a minore sopravvivenza  
- **Magnitude del coefficiente**: Quantifica l'entità dell'effetto prognostico
- **Significatività (p < 0.005)**: Conferma la rilevanza statistica del fattore

\newpage

# Salvataggio del Dataset Pulito

## Esportazione dei Dati Processati

```{r save_cleaned_dataset}
output_path_csv <- "../result/dataset_pulito.csv"
output_path_excel <- "../result/dataset_pulito.xlsx"

write.csv(cleaned_data, output_path_csv, row.names = FALSE)

if(require("writexl", quietly = TRUE)) {
  writexl::write_xlsx(cleaned_data, output_path_excel)
  cat("[OK] Dataset pulito salvato in formato Excel:", output_path_excel, "\n")
}

cat("[OK] Dataset pulito salvato in formato CSV:", output_path_csv, "\n")
cat("[FINALE] Dimensioni finali:", nrow(cleaned_data), "pazienti x", ncol(cleaned_data), "variabili\n")

final_summary <- data.frame(
  Caratteristica = c("Pazienti totali", "Variabili totali", "Valori mancanti rimanenti",
                     "Pazienti con OS completa", "Follow-up mediano (mesi)"),
  Valore = c(nrow(cleaned_data), ncol(cleaned_data), 
            sum(is.na(cleaned_data)), 
            sum(!is.na(cleaned_data$OS)),
            round(median(cleaned_data$OS, na.rm = TRUE), 1))
)

knitr::kable(final_summary,
             caption = "Riassunto del Dataset Finale",
             booktabs = TRUE, row.names = FALSE)
```

\newpage

# Conclusioni e Considerazioni Cliniche

## Principali Scoperte dell'Analisi

### Caratteristiche Demografiche e Cliniche

L'analisi ha rivelato una **popolazione pediatrica eterogenea** con diverse presentazioni cliniche che riflettono la **complessità biologica** dei tumori cerebrali in età pediatrica.

### Pattern di Presentazione Clinica

I **sintomi neurologici** mostrano prevalenze coerenti con la letteratura, confermando l'importanza della **diagnosi precoce** e del riconoscimento tempestivo dei segni di ipertensione intracranica.

### Distribuzione degli Istotipi

La **distribuzione istopatologica** evidenzia la prevalenza di gliomi di basso grado, suggerendo una casistica con **prognosi relativamente favorevole** rispetto a coorti di centri terziarii.

### Outcome di Sopravvivenza

I **dati di sopravvivenza** mostrano una **mediana elevata**, indicativa di buoni risultati terapeutici, possibilmente correlati a:
- Diagnosi precoce
- Protocolli terapeutici ottimizzati  
- Selezione casistica

## Implicazioni per la Pratica Clinica

### Stratificazione Prognostica

I **fattori prognostici identificati** possono essere utilizzati per:
- **Risk stratification** dei pazienti
- **Personalizzazione** dei protocolli terapeutici
- **Counseling** informato delle famiglie

### Ottimizzazione Terapeutica

L'analisi suggerisce l'importanza di:
- **Approcci multimodali** (chirurgia + radioterapia + chemioterapia)
- **Timing ottimale** degli interventi terapeutici
- **Monitoraggio personalizzato** basato su fattori di rischio

### Follow-up e Sorveglianza

I **pattern identificati** supportano:
- **Protocolli di follow-up differenziati** per istotipo
- **Sorveglianza intensiva** per pazienti ad alto rischio
- **Qualità di vita** come endpoint secondario importante

## Limitazioni dello Studio

### Limitazioni Metodologiche

- **Studio retrospettivo**: Possibili bias di selezione e informazione
- **Missing data**: Potenziale impatto sui risultati statistici
- **Follow-up eterogeneo**: Possibile censura informativa

### Limitazioni Statistiche

- **Soglia conservativa (p < 0.005)**: Può aumentare errori di Tipo II
- **Correlazioni non causali**: Necessità di validazione prospettica
- **Modelli lineari**: Possibili relazioni non-lineari non catturate

### Generalizzabilità

- **Popolazione specifica**: Risultati potrebbero non essere generalizzabili
- **Era temporale**: Possibili cambiamenti nei protocolli terapeutici
- **Centro singolo**: Variabilità inter-istituzionale non valutata

## Raccomandazioni per Ricerche Future

### Studi Prospettici

- **Validazione prospettica** dei fattori prognostici identificati
- **Biomarkers molecolari** per raffinare la stratificazione
- **Qualità di vita** come endpoint primario in sottogruppi

### Analisi Avanzate

- **Machine learning** per pattern recognition complessi
- **Analisi di sopravvivenza avanzate** (Kaplan-Meier, Cox regression)
- **Genomica** per medicina di precisione

### Studi Multicentrici

- **Validazione esterna** in coorti indipendenti
- **Standardizzazione** protocolli diagnostico-terapeutici
- **Network collaborativi** per rare neoplasie pediatriche

## Bibliografia

1. **Marr C, et al.** Multi-scale modeling in biology: How to bridge the gaps between scales? *PLoS Comput Biol* 2012. DOI: [10.1371/journal.pcbi.1000424](https://doi.org/10.1371/journal.pcbi.1000424)

2. **Ahmed KA, et al.** Clinical and dosimetric predictors of radiation-induced brainstem toxicity in pediatric patients. *PLoS One* 2021. DOI: [10.1371/journal.pone.0259095](https://doi.org/10.1371/journal.pone.0259095)

3. **Yarkoni T, Westfall J.** Choosing prediction over explanation in psychology: Lessons from machine learning. *Nat Hum Behav* 2017. DOI: [10.1038/s41562-017-0189-z](https://doi.org/10.1038/s41562-017-0189-z)

4. **Zhang Y, et al.** Computational approaches for modeling metabolic networks in cancer systems biology. *PLoS Comput Biol* 2025. DOI: [10.1371/journal.pcbi.1012946](https://doi.org/10.1371/journal.pcbi.1012946)

---
